(()=>{"use strict";const t=17;class e{constructor(){const t=new Array(12);for(let e=0;e<t.length;++e){t[e]=new Array(21);for(let s=0;s<t[e].length;++s)t[e][s]=-2}this.grid=t}toJSON(){return{grid:this.grid}}isEmpty(t,e){return-1==this.grid[e][t]}setEmpty(t,e){return this.grid[e][t]=-1}getTileId(t,e){return this.grid[e+2][t+2]}init(e){if(e&&void 0!==e.grid)this.grid=e.grid;else{for(let t=1;t<11;++t)for(let e=1;e<20;++e)this.grid[t][e]=-1;for(let e=0;e<4;++e)for(let e=0;e<34;++e){let s,i;do{s=Math.random()*t+2|0,i=8*Math.random()+2|0}while(-1!=this.grid[i][s]);this.grid[i][s]=e}}}findSimilarTiles(t,e){const s=this.grid[e][t];if(-1==s)return null;const i=[];for(let n=2;n<10;++n)for(let l=2;l<19;++l)l==t&&n==e||this.grid[n][l]!=s||i.push({x:l,y:n});return i}shuffle(){for(let e=2;e<10;++e)for(let s=2;s<19;++s)if(this.grid[e][s]>=0){let i,n;do{i=Math.random()*t+2|0,n=8*Math.random()+2|0}while(this.grid[n][i]<0||i==s&&n==e);const l=this.grid[e][s];this.grid[e][s]=this.grid[n][i],this.grid[n][i]=l}}tileRemains(){for(let t=2;t<10;++t)for(let e=2;e<19;++e)if(this.grid[t][e]>=0)return!0;return!1}tileMap(){const t={};for(let e=2;e<10;++e)for(let s=2;s<19;++s){const i=this.grid[e][s];i>=0&&(t[i]?t[i].push({x:s,y:e}):t[i]=[{x:s,y:e}])}return t}tileImage(t,e){const s=void 0===e?t:this.grid[e+2][t+2];return"images/tile/"+"mpsj"[s/9|0]+(s%9+1|0)+".png"}}class s{constructor(){this.context=null,this.centerX=0,this.centerY=0,this.gridWidth=0,this.gridHeight=0}init(t,e,s,i,n,l,a){const r=document.getElementById("connect");r&&r.getContext&&(r.width=0|t,r.height=0|e,this.context=r.getContext("2d"),this.context.strokeStyle="rgba(0, 255, 0, 0.5)",this.context.lineWidth=a,this.centerX=s,this.centerY=i,this.gridWidth=n,this.gridHeight=l)}clear(){document.getElementById("connect").style.display="none";const t=this.context;t&&t.clearRect(0,0,t.canvas.width,t.canvas.height)}draw(t){const e=this.context;if(!e)return;const s=this.centerX,i=this.centerY,n=this.gridWidth,l=this.gridHeight;e.beginPath(),e.moveTo((t[0][0]-2)*n+s+n/2,(t[0][1]-2)*l+i+l/2);for(let a=1;a<t.length;++a)e.lineTo((t[a][0]-2)*n+s+n/2,(t[a][1]-2)*l+i+l/2);e.stroke(),document.getElementById("connect").style.display="block"}}class i{constructor(t,e,s,i){this.id=t;const n=document.getElementById(this.id);if(n.className="button",n.style.backgroundImage=`url("images/${this.id}.png")`,i&&n.addEventListener("click",i),s){const t=document.createElement("span");t.className="cost-frame",t.textContent=s,n.appendChild(t)}this.resize(e)}resize(t){const e=document.getElementById(this.id);e.style.width=160*t+"px",e.style.height=92*t+"px",e.hasChildNodes()&&(e.childNodes[0].style.fontSize=32*t+"px")}enable(t){const e=document.getElementById(this.id);t?e.classList.remove("disable"):e.classList.add("disable")}}class n{#t=160;#e=64;constructor(t,e,s){this.id=t;const i=document.getElementById(this.id);i.style.backgroundImage='url("images/swap.png")',i.addEventListener("click",s),this.resize(e)}resize(t){const e=document.getElementById(this.id);e.style.width=this.#t*t+"px",e.style.height=this.#e*t+"px"}}class l{constructor(){const t=document.getElementById("message");for(let e=0;e<4;++e){const s=document.createElement("img");s.className="character",s.src=`images/gameover${e+1}.png`,t.appendChild(s)}this.beginTime=0,this.maxWidth=160,this.maxHeight=160}init(){const t=document.getElementById("base"),e=t.clientWidth,s=t.clientHeight/2-this.maxHeight/2,i=this.maxHeight,n=document.getElementById("message");for(let t=0;t<n.childNodes.length;++t){const l=n.childNodes[t];l.dataset.x=e/2+(t-2)*this.maxWidth+this.maxWidth/2,l.style.left=`${l.dataset.x}px`,l.style.top=`${s}px`,l.style.width="0px",l.style.height=`${i}px`}n.style.display="block",requestAnimationFrame(this.update.bind(this))}clear(){document.getElementById("message").style.display="none"}update(t){this.beginTime||(this.beginTime=t);const e=document.getElementById("message"),s=t-this.beginTime;for(let t=0;t<e.childNodes.length;++t){const i=e.childNodes[t],n=s-300*t;if(n>=0){const t=n<1e3?n/1e3*this.maxWidth:this.maxWidth,e=0|i.dataset.x;i.style.left=e-t/2+"px",i.style.width=`${t}px`}}s<1900&&requestAnimationFrame(this.update.bind(this))}resize(t){this.ratio=t,this.maxWidth=160*t,this.maxHeight=160*t;const e=performance.now()-this.beginTime,s=document.getElementById("base"),i=s.clientWidth,n=s.clientHeight/2-this.maxHeight/2,l=this.maxHeight,a=document.getElementById("message");for(let t=0;t<a.childNodes.length;++t){const s=a.childNodes[t],r=e-300*t;if(r>=0){s.dataset.x=i/2+(t-2)*this.maxWidth+this.maxWidth/2;const e=r<1e3?r/1e3*this.maxWidth:this.maxWidth,a=0|s.dataset.x;s.style.left=a-e/2+"px",s.style.top=`${n}px`,s.style.width=`${e}px`,s.style.height=`${l}px`}}}}class a{constructor(){this.score=0,this.resize(1),this.update()}toJSON(){return{score:this.score}}restore(t){this.score=t.score,this.update()}get initValue(){return{score:0}}init(){this.score=0,this.update()}add(t){this.score+=t,this.update()}resize(t){document.getElementById("score").style.fontSize=32*t+"px"}update(){document.getElementById("score").textContent=`得点: ${this.score}`}}class r{constructor(){this.restOfBalls=10,this.ballWidth=32,this.ballHeight=32}toJSON(){return{restOfBalls:this.restOfBalls}}get initValue(){return{restOfBalls:10}}init(t,e){this.restOfBalls=e?e.restOfBalls:10,void 0!==t&&(this.ballWidth=32*t,this.ballHeight=32*t);const s=document.getElementById("basket"),i=s.parentElement.clientWidth>s.parentElement.clientHeight;s.textContent="",s.style.width=i?"auto":`${Math.ceil(5*this.ballWidth)}px`,s.style.height=i?`${this.ballHeight}px`:"auto",this.addAnime(this.restOfBalls)}resize(t){this.ballWidth=32*t,this.ballHeight=32*t;const e=document.getElementById("basket"),s=e.parentElement.clientWidth>e.parentElement.clientHeight;e.style.width=s?"auto":`${Math.ceil(5*this.ballWidth)}px`,e.style.height=s?`${this.ballHeight}px`:"auto";for(let t=0;t<e.childNodes.length;++t){const s=e.childNodes[t];s.style.width=`${this.ballWidth}px`,s.style.height=`${this.ballHeight}px`}}add(t){t=Math.abs(t),this.restOfBalls+=t,this.addAnime(t)}remove(t){if((t=Math.abs(t))>this.restOfBalls)return!1;const e=this.restOfBalls;this.restOfBalls-=t;const s=document.getElementById("basket");for(let t=e-1;t>=this.restOfBalls;--t)s.childNodes[t].classList.add("eliminate");return!0}addAnime(t,e){if(e&&e.classList.remove("brightly"),t<=0)return;const s=document.getElementById("basket");let i=s.childNodes.length?s.childNodes[this.restOfBalls-t]:null;if(i&&i.classList.contains("eliminate"))i.classList.remove("eliminate"),i.classList.add("brightly"),i.style.width=`${this.ballWidth}px`,i.style.height=`${this.ballHeight}px`;else{const t=document.createElement("span");t.className="ball brightly",t.style.width=`${this.ballWidth}px`,t.style.height=`${this.ballHeight}px`,document.getElementById("basket").appendChild(t),i=t}requestAnimationFrame(this.addAnime.bind(this,t-1,i))}}let o=null;const c={},d=function(t,e,s){return new Promise(((i,n)=>{const l=indexedDB.open(t,e);l.onerror=t=>n(t.target.error),l.onsuccess=async t=>{const e=t.target.result;e.onerror=t=>console.error(t.target.error),o=e,c[1]=await new Promise(((t,e)=>{const s=o.transaction(o.name).objectStore(o.name).get(1);s.onerror=t=>e(t.target.error),s.onsuccess=e=>t(e.target.result)})),i(c[1])},l.onupgradeneeded=e=>{const i=e.target.result;i.onerror=t=>console.error(t.target.error),i.createObjectStore(t,{autoIncrement:!0}).put(Object.fromEntries(s.map((t=>[t.name,t.defaultValue]))))}}))},h=function(t,e=1){return c[e][t]},u=function(t,e=1){for(const s in t)c[e][s]=t[s];new Promise(((s,i)=>{const n=o.transaction(o.name,"readwrite").objectStore(o.name);n.onerror=t=>i(t.target.error);const l=n.openCursor(e);l.onerror=t=>i(t.target.error),l.onsuccess=e=>{const s=e.target.result;if(s){for(const e in t)s.value[e]=t[e];s.update(s.value),s.continue()}}}))};!function(){let o,c,g=1,m=64,y=86,f=64,p=104,x=24,b=16;let B=!1;const E=new e,I=new s,w=[],T=new l,$=new a,k=new r;function W(t,e){const s=t/1280,i=e/800;return s<i?s:i}function N(e,s){return g=W(e,s),m=64*g,y=86*g,f=64*g,p=104*g,x=24*g,b=16*g,o=e/2-m*t/2,c=s/2-8*y/2,g}function O(t,e){return`grid${t}-${e}`}function v(t,e){return document.getElementById(O(t,e))}const H=new class{constructor(){this.selectedTile=null}get isEmpty(){return null==this.selectedTile}get gridId(){return this.selectedTile.id}get tileType(){return this.selectedTile.dataset.tileType}get gridX(){return 0|this.selectedTile.dataset.gx}get gridY(){return 0|this.selectedTile.dataset.gy}detach(){const t=this.selectedTile;return this.selectedTile=null,t}set(t){I.clear();const e=this.selectedTile;e&&(e.style.top=`${((0|e.dataset.gy)-2)*y+c}px`),t.style.top=((0|t.dataset.gy)-2)*y+c-b+"px",this.selectedTile=t}clear(){I.clear();const t=this.selectedTile;t&&(t.style.top=`${((0|t.dataset.gy)-2)*y+c}px`),this.selectedTile=null}};function L(){w[1].enable(k.restOfBalls>=1),w[2].enable(k.restOfBalls>=5)}const S=function(){const t=new Array(12);for(let e=0;e<t.length;++e)t[e]=new Array(21);const e=[0,1,0,-1],s=[-1,0,1,0],i=(i,n,l,a)=>{for(;i+=e[l],!t[n+=s[l]][i];)a&&(t[n][i]=1);return t[n][i]>0?[[i,n]]:null},n=(n,l,a)=>{for(;n+=e[a],!t[l+=s[a]][n];){t[l][n]=1;let e=(a+1)%4,s=i(n,l,e,!1);if(s)return s.concat([[n,l]]);if(e=(e+2)%4,s=i(n,l,e,!1),s)return s.concat([[n,l]])}return t[l][n]>0?[[n,l]]:null};return function(e,s,l,a){for(let e=0;e<t.length;++e)for(let s=0;s<t[e].length;++s)t[e][s]=E.isEmpty(s,e)?0:-1;t[s][e]=1,t[a][l]=1;const r=[[e,s]];let o=null;if(null!=(o=i(e,s,0,!0))||null!=(o=i(e,s,1,!0))||null!=(o=i(e,s,2,!0))||null!=(o=i(e,s,3,!0)))return r.concat(o);const c=l-e,d=a-s;let h,u,g,m;return Math.abs(c)>=Math.abs(d)?(c>=0?(h=3,m=1):(h=1,m=3),d>=0?(u=0,g=2):(u=2,g=0)):(d>=0?(h=0,m=2):(h=2,m=0),c>=0?(u=3,g=1):(u=1,g=3)),null!=(o=n(l,a,h))||null!=(o=n(l,a,u))||null!=(o=n(l,a,g))||null!=(o=n(l,a,m))?r.concat(o).concat([[l,a]]):null}}();function z(){for(let t=2;t<10;++t)for(let e=2;e<19;++e){const s=E.findSimilarTiles(e,t);if(s)for(let i=0;i<s.length;++i){const n=S(e,t,s[i].x,s[i].y);if(n)return{pair:[{x:e,y:t},s[i]],line:n}}}return null}function A(t){const e=[];let s=!1;for(const i in t){const n=t[i];for(let t=0;t<n.length-1;++t)for(let i=t+1;i<n.length;++i){const l=S(n[t].x,n[t].y,n[i].x,n[i].y);l?e.push({pair:[n[t],n[i]],line:l}):s=!0}}return{canTaken:e,canAllTaken:!s}}function P(t){if(!t||B)return;B=!0;const e=t.pair,s=t.line,i=v(e[0].x-2,e[0].y-2),n=v(e[1].x-2,e[1].y-2);i.style.top=((0|i.dataset.gy)-2)*y+c-b+"px",n.style.top=((0|n.dataset.gy)-2)*y+c-b+"px",I.draw(s),requestAnimationFrame(J.bind(this,i,n,b))}function M(e){H.clear(),E.init(e?.grid);for(let e=0;e<8;++e)for(let s=0;s<t;++s){const t=v(s,e);t&&(t.dataset.tileType=E.getTileId(s,e),t.style.top=`${e*y+c}px`,t.style.display="inline",t.style.opacity=1,t.style.backgroundImage=`url("${E.tileImage(s,e)}")`)}k.add(h("bonusScore")),L(),u({gamePhase:void 0!==e?.gamePhase?e.gamePhase:1,bonusScore:0,grid:E.toJSON(),scoreBoard:$.toJSON(),basket:k.toJSON()})}function J(t,e,s){if(s>0){let i=b-s;i*=i,i+=b;const n=t=>{const e=0|t.dataset.gy;t.style.top=(e-2)*y+c-i+"px",t.style.opacity=s/b};return n(t),n(e),--s,void requestAnimationFrame(J.bind(this,t,e,s))}const i=t=>{E.setEmpty(t.dataset.gx,t.dataset.gy),t.dataset.tileType=-1,t.style.display="none"};i(t),i(e),B=!1,I.clear(),function(){const t=E.tileMap();let e=0;for(const s in t)e+=t[s].length;if(!e)return u({gamePhase:3}),void M();const s={grid:E.toJSON()},i=A(t);if(i.canTaken.length){if(i.canAllTaken){let t=h("bonusScore");++t,$.add(t),s.gamePhase=4,s.bonusScore=t,s.scoreBoard=$.toJSON(),P(i.canTaken[0])}}else z()&&alert("checkRestOfTile: tile remains."),s.gamePhase=2,T.init();u(s)}()}function V(){T.clear(),$.init(),k.init(),M()}function C(){if(!k.remove(1))return;L();const t=A(E.tileMap());for(let e=0;e<t.canTaken.length;++e){const s=t.canTaken[e].pair;v(s[0].x-2,s[0].y-2).classList.add("hint"),v(s[1].x-2,s[1].y-2).classList.add("hint")}H.clear(),u({basket:k.toJSON()})}function j(){k.remove(5)&&(L(),T.clear(),function(){H.clear(),E.shuffle();for(let e=0;e<8;++e)for(let s=0;s<t;++s){const t=v(s,e);t&&(t.dataset.tileType=E.getTileId(s,e),t.style.top=`${e*y+c}px`,t.style.opacity=1,t.style.backgroundImage=`url("${E.tileImage(s,e)}")`)}}(),u({gamePhase:1,basket:k.toJSON()}))}function q(){const t=document.getElementById("basic-layout");t.classList.contains("L-status")?(t.classList.replace("L-status","R-status"),u({layout:"R-status"})):(t.classList.replace("R-status","L-status"),u({layout:"L-status"}))}addEventListener("load",(async()=>{const e=await d("js2kakudori",22121601,[{name:"gamePhase",defaultValue:1},{name:"bonusScore",defaultValue:0},{name:"grid",defaultValue:void 0},{name:"scoreBoard",defaultValue:$.initValue},{name:"basket",defaultValue:k.initValue},{name:"layout",defaultValue:"L-status"}]);$.restore(e.scoreBoard);const s=document.getElementById("base"),l=W(s.clientWidth,s.clientHeight);document.getElementById("control-box").style.padding=`${96*l}px 0 ${48*l}px`,$.resize(l),w.push(new i("reset",l,0,V)),w.push(new i("hint",l,1,C)),w.push(new i("shuffle",l,5,j)),w.push(new n("swap",l,q)),k.init(l,e.basket),T.resize(l),document.getElementById("basic-layout").classList.add(e.layout);const a=document.getElementById("mat"),r=a.clientWidth,g=a.clientHeight;N(r,g),I.init(r,g,o,c,m,y,x);const B=function(){if(1==h("gamePhase")&&-1!=this.dataset.tileType)if(H.isEmpty)H.set(this);else if(this.id==H.gridId)H.clear();else if(this.dataset.tileType===H.tileType){const e=S(H.gridX,H.gridY,0|this.dataset.gx,0|this.dataset.gy);if(e){const s=H.detach(),i=this;i.style.top=((0|i.dataset.gy)-2)*y+c-b+"px",$.add(1),I.draw(e),requestAnimationFrame(J.bind(this,s,i,b));for(let e=0;e<8;++e)for(let s=0;s<t;++s)v(s,e).classList.remove("hint");u({scoreBoard:$.toJSON()})}}else H.set(this)},L=document.getElementById("connect");for(let e=0;e<8;++e)for(let s=0;s<t;++s){const t=document.createElement("div");t.id=O(s,e),t.className="tile",t.dataset.gx=s+2,t.dataset.gy=e+2,t.dataset.tileType=-1,t.style.width=`${f}px`,t.style.height=`${p}px`,t.style.left=`${s*m+o}px`,t.style.top=`${e*y+c}px`,t.style.backgroundImage=`url("${E.tileImage(0)}")`,t.onclick=B,a.insertBefore(t,L)}M(e),2==h("gamePhase")&&T.init()})),addEventListener("resize",(()=>{const e=document.getElementById("base"),s=W(e.clientWidth,e.clientHeight);document.getElementById("control-box").style.padding=`${96*s}px 0 ${48*s}px`,$.resize(s);for(let t=0;t<w.length;++t)w[t].resize(s);k.resize(s),T.resize(s);const i=document.getElementById("mat"),n=i.clientWidth,l=i.clientHeight;N(n,l),I.init(n,l,o,c,m,y,x),H.clear();for(let e=0;e<8;++e)for(let s=0;s<t;++s){const t=v(s,e);t.style.width=`${f}px`,t.style.height=`${p}px`,t.style.left=`${s*m+o}px`,t.style.top=`${e*y+c}px`}})),addEventListener("keydown",(t=>{"c"==t.key&&1==h("gamePhase")&&(console.log("[chart] auto take."),P(z()))}))}()})();