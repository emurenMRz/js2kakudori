(()=>{"use strict";const t=17;class e{constructor(){const t=new Array(12);for(let e=0;e<t.length;++e){t[e]=new Array(21);for(let i=0;i<t[e].length;++i)t[e][i]=-2}this.grid=t}isEmpty(t,e){return-1==this.grid[e][t]}setEmpty(t,e){return this.grid[e][t]=-1}getTileId(t,e){return this.grid[e+2][t+2]}init(){for(let t=1;t<11;++t)for(let e=1;e<20;++e)this.grid[t][e]=-1;for(let e=0;e<4;++e)for(let e=0;e<34;++e){let i,s;do{i=Math.random()*t+2|0,s=8*Math.random()+2|0}while(-1!=this.grid[s][i]);this.grid[s][i]=e}}findSimilarTiles(t,e){const i=this.grid[e][t];if(-1==i)return null;const s=[];for(let l=2;l<10;++l)for(let n=2;n<19;++n)n==t&&l==e||this.grid[l][n]!=i||s.push({x:n,y:l});return s}shuffle(){for(let e=2;e<10;++e)for(let i=2;i<19;++i)if(this.grid[e][i]>=0){let s,l;do{s=Math.random()*t+2|0,l=8*Math.random()+2|0}while(this.grid[l][s]<0||s==i&&l==e);const n=this.grid[e][i];this.grid[e][i]=this.grid[l][s],this.grid[l][s]=n}}tileRemains(){for(let t=2;t<10;++t)for(let e=2;e<19;++e)if(this.grid[t][e]>=0)return!0;return!1}tileMap(){const t={};for(let e=2;e<10;++e)for(let i=2;i<19;++i){const s=this.grid[e][i];s>=0&&(t[s]?t[s].push({x:i,y:e}):t[s]=[{x:i,y:e}])}return t}tileImage(t,e){const i=void 0===e?t:this.grid[e+2][t+2];return"images/tile/"+"mpsj"[i/9|0]+(i%9+1|0)+".png"}}class i{constructor(){this.context=null,this.centerX=0,this.centerY=0,this.gridWidth=0,this.gridHeight=0}init(t,e,i,s,l,n,a){const o=document.getElementById("connect");o&&o.getContext&&(o.width=0|t,o.height=0|e,this.context=o.getContext("2d"),this.context.strokeStyle="rgba(0, 255, 0, 0.5)",this.context.lineWidth=a,this.centerX=i,this.centerY=s,this.gridWidth=l,this.gridHeight=n)}clear(){document.getElementById("connect").style.display="none";const t=this.context;t&&t.clearRect(0,0,t.canvas.width,t.canvas.height)}draw(t){const e=this.context;if(!e)return;const i=this.centerX,s=this.centerY,l=this.gridWidth,n=this.gridHeight;e.beginPath(),e.moveTo((t[0][0]-2)*l+i+l/2,(t[0][1]-2)*n+s+n/2);for(let a=1;a<t.length;++a)e.lineTo((t[a][0]-2)*l+i+l/2,(t[a][1]-2)*n+s+n/2);e.stroke(),document.getElementById("connect").style.display="block"}}class s{constructor(t,e,i,s){this.id=t;const l=document.getElementById(this.id);if(l.className="button",l.style.backgroundImage=`url("images/${this.id}.png")`,s&&l.addEventListener("click",s),i){const t=document.createElement("span");t.className="cost-frame",t.textContent=i,l.appendChild(t)}this.resize(e)}resize(t){const e=document.getElementById(this.id);e.style.width=160*t+"px",e.style.height=92*t+"px",e.hasChildNodes()&&(e.childNodes[0].style.fontSize=32*t+"px")}enable(t){const e=document.getElementById(this.id);t?e.classList.remove("disable"):e.classList.add("disable")}}class l{constructor(){const t=document.getElementById("message");for(let e=0;e<4;++e){const i=document.createElement("img");i.className="character",i.src=`images/gameover${e+1}.png`,t.appendChild(i)}this.beginTime=0,this.maxWidth=160,this.maxHeight=160}init(){const t=document.getElementById("base"),e=t.clientWidth,i=t.clientHeight/2-this.maxHeight/2,s=this.maxHeight,l=document.getElementById("message");for(let t=0;t<l.childNodes.length;++t){const n=l.childNodes[t];n.dataset.x=e/2+(t-2)*this.maxWidth+this.maxWidth/2,n.style.left=`${n.dataset.x}px`,n.style.top=`${i}px`,n.style.width="0px",n.style.height=`${s}px`}l.style.display="block",this.beginTime=Date.now(),setTimeout((()=>this.update()),16)}clear(){document.getElementById("message").style.display="none"}update(){const t=document.getElementById("message"),e=Date.now()-this.beginTime;for(let i=0;i<t.childNodes.length;++i){const s=t.childNodes[i],l=e-300*i;if(l>=0){const t=l<1e3?l/1e3*this.maxWidth:this.maxWidth,e=0|s.dataset.x;s.style.left=e-t/2+"px",s.style.width=`${t}px`}}e<1900&&setTimeout((()=>this.update()),16)}resize(t){this.ratio=t,this.maxWidth=160*t,this.maxHeight=160*t;const e=Date.now()-this.beginTime,i=document.getElementById("base"),s=i.clientWidth,l=i.clientHeight/2-this.maxHeight/2,n=this.maxHeight,a=document.getElementById("message");for(let t=0;t<a.childNodes.length;++t){const i=a.childNodes[t],o=e-300*t;if(o>=0){i.dataset.x=s/2+(t-2)*this.maxWidth+this.maxWidth/2;const e=o<1e3?o/1e3*this.maxWidth:this.maxWidth,a=0|i.dataset.x;i.style.left=a-e/2+"px",i.style.top=`${l}px`,i.style.width=`${e}px`,i.style.height=`${n}px`}}}}class n{constructor(){this.score=0,this.resize(1),this.update()}init(){this.score=0,this.update()}add(t){this.score+=t,this.update()}resize(t){document.getElementById("score").style.fontSize=32*t+"px"}update(){document.getElementById("score").textContent=`得点: ${this.score}`}}class a{constructor(){this.restOfBalls=10,this.ballWidth=32,this.ballHeight=32}init(t){this.restOfBalls=10,void 0!==t&&(this.ballWidth=32*t,this.ballHeight=32*t);const e=document.getElementById("basket"),i=e.parentElement.clientWidth>e.parentElement.clientHeight;e.textContent="",e.style.width=i?"auto":`${Math.ceil(5*this.ballWidth)}px`,e.style.height=i?`${this.ballHeight}px`:"auto",this.addAnime(this.restOfBalls)}resize(t){this.ballWidth=32*t,this.ballHeight=32*t;const e=document.getElementById("basket"),i=e.parentElement.clientWidth>e.parentElement.clientHeight;e.style.width=i?"auto":`${Math.ceil(5*this.ballWidth)}px`,e.style.height=i?`${this.ballHeight}px`:"auto";for(let t=0;t<e.childNodes.length;++t){const i=e.childNodes[t];i.style.width=`${this.ballWidth}px`,i.style.height=`${this.ballHeight}px`}}add(t){t=Math.abs(t),this.restOfBalls+=t,this.addAnime(t)}remove(t){if((t=Math.abs(t))>this.restOfBalls)return!1;const e=this.restOfBalls;this.restOfBalls-=t;const i=document.getElementById("basket");for(let t=e-1;t>=this.restOfBalls;--t)i.childNodes[t].classList.add("eliminate");return!0}addAnime(t,e){if(e&&e.classList.remove("brightly"),t<=0)return;const i=document.getElementById("basket");let s=i.childNodes.length?i.childNodes[this.restOfBalls-t]:null;if(s&&s.classList.contains("eliminate"))s.classList.remove("eliminate"),s.classList.add("brightly"),s.style.width=`${this.ballWidth}px`,s.style.height=`${this.ballHeight}px`;else{const t=document.createElement("span");t.className="ball brightly",t.style.width=`${this.ballWidth}px`,t.style.height=`${this.ballHeight}px`,document.getElementById("basket").appendChild(t),s=t}setTimeout((()=>this.addAnime(t-1,s)),50)}}!function(){let o,d,c=1,r=64,h=86,g=64,u=104,m=24,y=16;let p=0,f=0,x=!1;const b=new e,E=new i,T=[],I=new l,$=new n,B=new a;function w(t,e){const i=t/1280,s=e/800;return i<s?i:s}function W(e,i){return c=w(e,i),r=64*c,h=86*c,g=64*c,u=104*c,m=24*c,y=16*c,o=e/2-r*t/2,d=i/2-8*h/2,c}function k(t,e){return`grid${t}-${e}`}function H(t,e){return document.getElementById(k(t,e))}const v=new class{constructor(){this.selectedTile=null}get isEmpty(){return null==this.selectedTile}get gridId(){return this.selectedTile.id}get tileType(){return this.selectedTile.dataset.tileType}get gridX(){return 0|this.selectedTile.dataset.gx}get gridY(){return 0|this.selectedTile.dataset.gy}detach(){const t=this.selectedTile;return this.selectedTile=null,t}set(t){E.clear();const e=this.selectedTile;e&&(e.style.top=`${((0|e.dataset.gy)-2)*h+d}px`),t.style.top=((0|t.dataset.gy)-2)*h+d-y+"px",this.selectedTile=t}clear(){E.clear();const t=this.selectedTile;t&&(t.style.top=`${((0|t.dataset.gy)-2)*h+d}px`),this.selectedTile=null}};function N(){T[1].enable(B.restOfBalls>=1),T[2].enable(B.restOfBalls>=5)}const z=function(){const t=new Array(12);for(let e=0;e<t.length;++e)t[e]=new Array(21);const e=[0,1,0,-1],i=[-1,0,1,0],s=(s,l,n,a)=>{for(;s+=e[n],!t[l+=i[n]][s];)a&&(t[l][s]=1);return t[l][s]>0?[[s,l]]:null},l=(l,n,a)=>{for(;l+=e[a],!t[n+=i[a]][l];){t[n][l]=1;let e=(a+1)%4,i=s(l,n,e,!1);if(i)return i.concat([[l,n]]);if(e=(e+2)%4,i=s(l,n,e,!1),i)return i.concat([[l,n]])}return t[n][l]>0?[[l,n]]:null};return function(e,i,n,a){for(let e=0;e<t.length;++e)for(let i=0;i<t[e].length;++i)t[e][i]=b.isEmpty(i,e)?0:-1;t[i][e]=1,t[a][n]=1;const o=[[e,i]];let d=null;if(null!=(d=s(e,i,0,!0))||null!=(d=s(e,i,1,!0))||null!=(d=s(e,i,2,!0))||null!=(d=s(e,i,3,!0)))return o.concat(d);const c=n-e,r=a-i;let h,g,u,m;return Math.abs(c)>=Math.abs(r)?(c>=0?(h=3,m=1):(h=1,m=3),r>=0?(g=0,u=2):(g=2,u=0)):(r>=0?(h=0,m=2):(h=2,m=0),c>=0?(g=3,u=1):(g=1,u=3)),null!=(d=l(n,a,h))||null!=(d=l(n,a,g))||null!=(d=l(n,a,u))||null!=(d=l(n,a,m))?o.concat(d).concat([[n,a]]):null}}();function L(){for(let t=2;t<10;++t)for(let e=2;e<19;++e){const i=b.findSimilarTiles(e,t);if(i)for(let s=0;s<i.length;++s){const l=z(e,t,i[s].x,i[s].y);if(l)return{pair:[{x:e,y:t},i[s]],line:l}}}return null}function M(t){const e=[];let i=!1;for(const s in t){const l=t[s];for(let t=0;t<l.length-1;++t)for(let s=t+1;s<l.length;++s){const n=z(l[t].x,l[t].y,l[s].x,l[s].y);n?e.push({pair:[l[t],l[s]],line:n}):i=!0}}return{canTaken:e,canAllTaken:!i}}function O(t){if(!t||x)return;x=!0;const e=t.pair,i=t.line,s=H(e[0].x-2,e[0].y-2),l=H(e[1].x-2,e[1].y-2);s.style.top=((0|s.dataset.gy)-2)*h+d-y+"px",l.style.top=((0|l.dataset.gy)-2)*h+d-y+"px",E.draw(i),setTimeout((()=>C(s,l,y)),16)}function A(){v.clear(),b.init();for(let e=0;e<8;++e)for(let i=0;i<t;++i){const t=H(i,e);t&&(t.dataset.tileType=b.getTileId(i,e),t.style.top=`${e*h+d}px`,t.style.display="inline",t.style.opacity=1,t.style.backgroundImage=`url("${b.tileImage(i,e)}")`)}B.add(f),N(),f=0,p=1}function C(t,e,i){if(i>0){let s=y-i;s*=s,s+=y;const l=t=>{const e=0|t.dataset.gy;t.style.top=(e-2)*h+d-s+"px",t.style.opacity=i/y};return l(t),l(e),--i,void setTimeout((()=>C(t,e,i)),16)}const s=t=>{b.setEmpty(t.dataset.gx,t.dataset.gy),t.dataset.tileType=-1,t.style.display="none"};s(t),s(e),x=!1,E.clear(),function(){const t=b.tileMap();let e=0;for(const i in t)e+=t[i].length;if(!e)return p=3,void A();const i=M(t);i.canTaken.length?i.canAllTaken&&(p=4,++f,$.add(f),O(i.canTaken[0])):(L()&&alert("checkRestOfTile: tile remains."),p=2,I.init())}()}function S(){I.clear(),$.init(),B.init(),A()}function X(){if(!B.remove(1))return;N();const t=M(b.tileMap());for(let e=0;e<t.canTaken.length;++e){const i=t.canTaken[e].pair;H(i[0].x-2,i[0].y-2).classList.add("hint"),H(i[1].x-2,i[1].y-2).classList.add("hint")}v.clear()}function Y(){B.remove(5)&&(N(),I.clear(),function(){v.clear(),b.shuffle();for(let e=0;e<8;++e)for(let i=0;i<t;++i){const t=H(i,e);t&&(t.dataset.tileType=b.getTileId(i,e),t.style.top=`${e*h+d}px`,t.style.opacity=1,t.style.backgroundImage=`url("${b.tileImage(i,e)}")`)}}(),p=1)}addEventListener("load",(()=>{const e=document.getElementById("base"),i=w(e.clientWidth,e.clientHeight);document.getElementById("control-box").style.padding=`${96*i}px 0 ${48*i}px`,$.resize(i),T.push(new s("reset",i,0,S)),T.push(new s("hint",i,1,X)),T.push(new s("shuffle",i,5,Y)),B.init(i),I.resize(i);const l=document.getElementById("mat"),n=l.clientWidth,a=l.clientHeight;W(n,a),E.init(n,a,o,d,r,h,m);const c=function(){if(1==p&&-1!=this.dataset.tileType)if(v.isEmpty)v.set(this);else if(this.id==v.gridId)v.clear();else if(this.dataset.tileType===v.tileType){const e=z(v.gridX,v.gridY,0|this.dataset.gx,0|this.dataset.gy);if(e){const i=v.detach(),s=this;s.style.top=((0|s.dataset.gy)-2)*h+d-y+"px",$.add(1),E.draw(e),setTimeout((()=>C(i,s,y)),16);for(let e=0;e<8;++e)for(let i=0;i<t;++i)H(i,e).classList.remove("hint")}}else v.set(this)},f=document.getElementById("connect");for(let e=0;e<8;++e)for(let i=0;i<t;++i){const t=document.createElement("div");t.id=k(i,e),t.className="tile",t.dataset.gx=i+2,t.dataset.gy=e+2,t.dataset.tileType=-1,t.style.width=`${g}px`,t.style.height=`${u}px`,t.style.left=`${i*r+o}px`,t.style.top=`${e*h+d}px`,t.style.backgroundImage=`url("${b.tileImage(0)}")`,t.onclick=c,l.insertBefore(t,f)}A()})),addEventListener("resize",(()=>{const e=document.getElementById("base"),i=w(e.clientWidth,e.clientHeight);document.getElementById("control-box").style.padding=`${96*i}px 0 ${48*i}px`,$.resize(i);for(let t=0;t<T.length;++t)T[t].resize(i);B.resize(i),I.resize(i);const s=document.getElementById("mat"),l=s.clientWidth,n=s.clientHeight;W(l,n),E.init(l,n,o,d,r,h,m),v.clear();for(let e=0;e<8;++e)for(let i=0;i<t;++i){const t=H(i,e);t.style.width=`${g}px`,t.style.height=`${u}px`,t.style.left=`${i*r+o}px`,t.style.top=`${e*h+d}px`}})),addEventListener("keydown",(t=>{"c"==t.key&&1==p&&(console.log("[chart] auto take."),O(L()))}))}()})();